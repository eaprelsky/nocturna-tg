# Nginx configuration for Nocturna Telegram Bot
# Скопируйте этот файл: sudo cp nginx-tg.nocturna.ru.conf /etc/nginx/sites-available/nocturna-tg
# Активируйте: sudo ln -s /etc/nginx/sites-available/nocturna-tg /etc/nginx/sites-enabled/
# Проверьте: sudo nginx -t
# Перезагрузите: sudo systemctl reload nginx

server {
    listen 80;
    listen [::]:80;
    server_name tg.nocturna.ru;

    # Логи
    access_log /var/log/nginx/tg.nocturna.ru_access.log;
    error_log /var/log/nginx/tg.nocturna.ru_error.log;

    # Локация для Certbot (Let's Encrypt)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Временно разрешаем HTTP до установки SSL
    # После установки сертификата эту секцию заменит редирект на HTTPS
    location / {
        return 404;
    }
}

# HTTPS configuration
# Раскомментируйте после установки SSL сертификата (sudo certbot --nginx -d tg.nocturna.ru)
# Certbot автоматически добавит свои строки, но этот блок можно использовать как референс

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name tg.nocturna.ru;
# 
#     # SSL certificates (будут добавлены certbot)
#     ssl_certificate /etc/letsencrypt/live/tg.nocturna.ru/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/tg.nocturna.ru/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
# 
#     # Логи
#     access_log /var/log/nginx/tg.nocturna.ru_access.log;
#     error_log /var/log/nginx/tg.nocturna.ru_error.log;
# 
#     # Security headers
#     add_header X-Content-Type-Options nosniff;
#     add_header X-Frame-Options DENY;
#     add_header X-XSS-Protection "1; mode=block";
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
# 
#     # Telegram webhook endpoint
#     location /webhook {
#         proxy_pass http://localhost:8080;
#         proxy_http_version 1.1;
#         
#         # Headers
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         # Telegram webhook требования (увеличены для долгих операций)
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         
#         # Размер буфера для тела запроса
#         client_max_body_size 10M;
#         
#         # Ограничение доступа только для Telegram серверов (опционально)
#         # https://core.telegram.org/bots/webhooks#the-short-version
#         # allow 149.154.160.0/20;
#         # allow 91.108.4.0/22;
#         # deny all;
#     }
# 
#     # Health check endpoint
#     location /health {
#         proxy_pass http://localhost:8080;
#         access_log off;
#         
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }
# 
#     # Остальные запросы - 404
#     location / {
#         return 404;
#     }
# }
# 
# # HTTP to HTTPS redirect (certbot добавит автоматически)
# server {
#     listen 80;
#     listen [::]:80;
#     server_name tg.nocturna.ru;
#     
#     location /.well-known/acme-challenge/ {
#         root /var/www/html;
#     }
#     
#     location / {
#         return 301 https://$server_name$request_uri;
#     }
# }

